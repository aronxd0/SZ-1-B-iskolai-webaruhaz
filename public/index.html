<html>
<head>
<title>Iskolai Webáruház</title>

<meta   charset="utf-8">
<link rel="icon" type="image/x-icon" href="/img/logoz.png">
<meta   name="viewport" content="width=device-width, initial-scale=1">
<link   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link   rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link   href="style.css" rel="stylesheet">

<script type="text/javascript">
  
  var ORDER = 1;
  var ID = 0;    
  const alerts = ["success", "info", "warning", "danger"];

  function üzen(mit, tip)  {
    alerts.forEach((element) => { $("#toast1").removeClass( "bg-"+element ); });  // előző osztályok nyekk...
    $("#toast1").addClass( "bg-"+tip );                                           // új class 
    $("#toast1 .toast-body").html(mit);  
    $("#toast1").toast( { delay: 5000 });
    $("#toast1").toast("show");  
  }

  function makeid(length) {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < length) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
      counter += 1;
    }
    return result;
  }

  function ajax_get( urlsor, hova, tipus, aszinkron ) {         // html oldalak beszúrására használjuk
    $.ajax({url: urlsor, type:"get", async:aszinkron, cache:false, dataType:tipus===0?'html':'json',
        beforeSend:function(xhr)   {  },
        success:   function(data)  { $(hova).html(data); },
        error:     function(jqXHR, textStatus, errorThrown) {üzen(jqXHR.responseText, "danger");},
        complete:  function()      {  }  
    });
    return true;
  };
  
  function ajax_post( urlsor, tipus  ) {                         // json restapi-hoz használjuk
    var s = "";
    $.ajax({url: urlsor, type:"post", async:false, cache:false, dataType:tipus===0?'html':'json',
        beforeSend:function(xhr)   {  },
        success:   function(data)  { s = data; },
        error:     function(jqXHR, textStatus, errorThrown) {üzen(jqXHR.responseText, "danger");},
        complete:  function()      {  }
    });
    return s;
  };  
  
  function orderby( num )   {
      ID = 0; // reset... nincs kijelölve egyetlen sor sem...
      ORDER = (ORDER === num) ? num * -1: num;
      Search_rekord();    
  }

  function Search_rekord() {
    $("tr.xsor").off('click');                          // unbind,

    $(document).on("click", "tr.xsor", function () {    /* MEG KELL ISMÉTELNI, mert az AJAX eldobja...*/
        ID = $(this).attr("id");                       
        var r_json = ajax_post("rekord/"+ID, 1 );       //console.log(r_json);
        var s= `<h3>ID: [${r_json.rows[0].ID_TERMEK}] ${r_json.rows[0].NEV}</h3>
                <h5>${r_json.rows[0].AR},-Ft ${r_json.rows[0].MENNYISEG} ${r_json.rows[0].MEEGYS}</h5>
                <p>${r_json.rows[0].LEIRAS}</p>
                <img class="img-fluid" src="${r_json.rows[0].FOTOLINK}"/>`;
        $("#rekord1").html(s);            
    }); 
      
    ID = 0;                                                           // ! reset, nincs kijelölve még egyetlen sor sem...
    $("#rekord1").empty();
    var s = "";
    var tip = "";    
    var old_offset =  $('#offset1').val();
    var url = "tabla?"+$("#form1").serialize()+"&order="+ORDER;       // console.log( url );
    var t_json   = ajax_post(url, 1) ;   // maxcount: max találat van limit nélkül
    var maxcount = t_json.maxcount | 0;  // :-)

    $("#tabla1 tbody").empty();                            // tábla sorok törlése (fejléc marad)

    if (t_json.message == "ok")                            // minden oksi ...
    {  
        var limit  = $('#limit1').val();
        var offset = Math.floor(maxcount / limit) + (maxcount % limit > 0? 1 : 0);
        $('#offset1').empty();
        var sel = "";
        for (var i=0; i < offset; ++i)
        {
          sel = (i==old_offset? "selected": "");
          $('#offset1').append(`<option ${sel} value="${i}">${i+1}.lap</option>`);
        }

        for (var i=0; i < t_json.rows.length; i++) 
        {
          var s = `<tr class="xsor table-${i%2==0?'primary':'light'}" 
                    id="${t_json.rows[i].ID_TERMEK}">
                    <td>${t_json.rows[i].NEV}</td>
                    <td>${t_json.rows[i].AR}</td>
                    <td>${t_json.rows[i].MENNYISEG}</td>
                    <td>${t_json.rows[i].MEEGYS}</td>
                  <tr>`;
          $("#tabla1 tbody").append(s);                     // tábla sorok beszúrása
        }
        tip = maxcount > 0? "success" : "warning";
        s = `Összesen ${maxcount} rekord felel meg a feltételnek.`;
    }
    else 
    {
      tip = "danger";
      s = t_json.message.sqlMessage;
    }
    üzen(s, tip);  
  }

  function Delete_rekord( idx ) {                        // törlés
    $("#myModal1 .modal-body").html(`Törlöd a ${idx} azonosítójú terméket?`); 
    $('#myModal1').off('click');                         // unbind, különben N.szer futna le az N. hívásra !!
    $("#myModal1").on("click",".btn-success", function(){
      var s = "";
      var tip = "success"; 
      var d_json = ajax_post("delete/"+ID, 1);
      console.log(d_json);
      if (d_json.message == "ok")                        // minden oksi ...
      {
        if (d_json.rows[0].affectedRows == 1) 
        {
          s= "Törlés OK..."; 
          Search_rekord();                               // refresh táblázat
        }     
        else                                    
        {
          tip = "warning";
          s= `Hiba: nincs meg az ID:[${idx}] azonosítójú rekord!<br>${d_json.message}`;}
        }
      else
      {
        tip = "danger";
        s = d_json.message;
      }  
      üzen(s, tip); 
    });
   
    $("#myModal1").modal('show');
  }

  function Save_rekord() {                              // bevitel, vagy módosítás
      var s = "";
      var tip = "success"; 
      var m_json = ajax_post("save/"+ID+"?"+$("#mod1").serialize(), 1);
      console.log(m_json);
      if (m_json.message == "ok")                       // minden oksi ...
      {
        if (m_json.rows[0].affectedRows == 1) 
        {
          s= "Módosítás OK..."; 
          Search_rekord();                              // refresh táblázat
        }     
        else                                    
        {
          tip = "warning";
          s= `Hiba: ID:[${idx}]!<br>${m_json.message}`;}
        }
      else
      {
        tip = "danger";
        s = m_json.message;
      }  
      üzen(s, tip); 
  }

  function Edit_rekord( idx ) {   
    $("#idx1").html("Termék " + (idx|0 > 0? "módosítás [ ID: "+idx+" ]" : "bevitel") ) ;   
    
    $("#mod_kat").empty();                              // listbox ürítése
    var k_json = ajax_post("kategoria", 1);             // JSON!
    var listItems  = "";
    for (var i = 0; i < k_json.rows.length; ++i)
    {
        listItems += `<option value='${k_json.rows[i].ID_KATEGORIA}'>${k_json.rows[i].KATEGORIA}</option>`;
    }

    $("#mod_kat").append(listItems);

    if (idx == 0)              // bevitel
    {
      $("#mod_nev").val("");
      $("#mod_azon").val(makeid(10));   // https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
      $("#mod_ar").val(0);
      $("#mod_db").val(1);
      $("#mod_meegys").val("darab");
      $("#mod_leiras").val("");

    } else                     // módosítás
    {
      var r_json = ajax_post("rekord/"+ID, 1 );
      $("#mod_kat").val(r_json.rows[0].ID_KATEGORIA).change();  // selected beállítása! https://stackoverflow.com/questions/13343566/set-select-option-selected-by-value
      $("#mod_nev").val(r_json.rows[0].NEV);
      $("#mod_azon").val(r_json.rows[0].AZON);
      $("#mod_ar").val(r_json.rows[0].AR);
      $("#mod_db").val(r_json.rows[0].MENNYISEG);
      $("#mod_meegys").val(r_json.rows[0].MEEGYS);
      $("#mod_leiras").val(r_json.rows[0].LEIRAS);
      var datum = new Date();                                 // now - de felesleges a dátum, mivel mysql auto....
      $("#mod_datum").val(datum.toISOString().split('T')[0]); // 2021-12-10T18:19:48.000Z'
    }
   
    $('#myModal0').modal('show');
  }






  $(document).ready(function() {
    update_gombok(0);           // insert, update, delete nem kell! (csak login után)
    $('#login_modal').modal('show');                           
    $("#kategoria1").empty(); 
    var listItems  = "";
    var k_json = ajax_post("kategoria", 1 );               // post kategoria, json formátum
    for (var i = 0; i < k_json.rows.length; ++i)
    {
        listItems +=`<option value='${k_json.rows[i].ID_KATEGORIA}'>${k_json.rows[i].KATEGORIA}</option>`;
    }
    $("#kategoria1").append(listItems);

    $("#search_button").click(function() {               Search_rekord();       } );
    $("#insert_button").click(function() {               Edit_rekord( 0 );      } );
    $("#modify_button").click(function() { if (ID > 0) { Edit_rekord( ID );   } } );
    $("#delete_button").click(function() { if (ID > 0) { Delete_rekord( ID ); } } );
    $("#save_button").click(function()   {               Save_rekord();         } );

    $("#login_button").click(function() {   
      if ($("#loginspan").html() == " Bejelentkezés") {
          $('#login_modal').modal('show'); 
      } else {   // logout
          var logout_json = ajax_post("logout", 1);  
          console.log(logout_json);
          $("#loginspan").html(' Bejelentkezés');
          $("#loginout").removeClass("bi bi-box-arrow-in-left");
          $("#loginout").addClass("bi bi-box-arrow-in-right");
          üzen("Sikeres logout", "success");
          update_gombok(0); 
          $("#user").html("");
          $("#user-email").html("");
      }  
    });

    $("#login_oksi_button").click(function() { 
      var l_json = ajax_post("login?"+$("#form_login").serialize(), 1) ;  
      if (l_json.message == "ok" && l_json.maxcount == 1) {  
            $("#user").html(`<h5><i class="bi bi-person"></i> ${l_json.rows[0].NEV}</h5>`);
            $("#user-email").html(`${l_json.rows[0].EMAIL}`);
            $('#login_modal').modal('hide');
            üzen(`Sikeres login: ${l_json.rows[0].NEV}!`,"success");
            update_gombok(1); 
            $("#loginspan").html(' Kijelentkezés');
            $("#loginout").removeClass("bi bi-box-arrow-in-right");
            $("#loginout").addClass("bi bi-box-arrow-in-left");

        } else {    
          üzen(`Hibás felhasználónév, vagy jelszó!`,"danger");
      }
    });


    // sotet mod - vilagos mod valto
    $("#switch").click(function() {
      if ($("html").attr("data-bs-theme") === "dark") {
        $("html").removeAttr("data-bs-theme");
        $("#switch").html(`<i class="bi bi-moon-fill"></i>`);
      }
      else {
        $("html").attr("data-bs-theme", "dark");
        $("#switch").html(`<i class="bi bi-sun-fill"></i>`);
      }
    });


    // jelszo mutatasa ikon a bejelentkezesnel
    $("#jelszo_mutatasa").click(function() {
      let v = $("#login_passwd"); // azert nincs .val() mert akkor leljebb nem lehetne attributumot valtoztatni
      
      if(v.attr('type') === 'password') {
        v.attr('type', 'text'); // atvaltozik szovegge tehat lathato lesz
        $("#sz").removeClass('bi-eye').addClass('bi-eye-slash');
      } 
      else {
        v.attr('type', 'password'); // vissza 
        $("#sz").removeClass('bi-eye-slash').addClass('bi-eye');
      }
    });


    $("#kereses_gomb").click(function() {
      var usernev = $("#user-email").html();
      alert(usernev);
    });


  });


  


  function update_gombok (x) {
    if (x == 0) { $("#insert_button").hide(); $("#modify_button").hide(); $("#delete_button").hide(); $("#admin_button").hide(); } 
    else        { $("#insert_button").show(); $("#modify_button").show(); $("#delete_button").show(); $("#admin_button").show(); }
  }
  
</script>


<body>

<div class="container-fluid"> <!-- fő div -->


   <!-- a bal oldali vezerlopult/menu -->
  <div class="offcanvas offcanvas-start" id="demo">  
    <div class="offcanvas-header text-center">
      <h5 class="offcanvas-title"><i class="bi bi-grid"></i>&nbsp;Vezérlőpult</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column"> <!-- d-flex: display flex
                                                         flex-column: oszlopkent mukodjon a div, a benne levo cuccok egymas alatt --> 

      
      <button id="login_button"  type="button" class="btn me-3 text-light" style="background-color: #125308;" data-bs-dismiss="offcanvas"> 
        <i class="bi bi-box-arrow-in-right" id="loginout"></i>
        <span  id="loginspan"> Bejelentkezés</span>
      </button>

      <button id="home_button"  type="button" class="btn btn-primary me-3 " data-bs-dismiss="offcanvas"> 
        <i class="bi bi-house" id="loginout"></i>
        <span  > Kezdőlap</span>
      </button>
    

    
      <button id="modify_button" type="button" class="btn btn-success me-3 "> 
        <i class="bi bi-cart2"></i>
        <span  > Kosár</span>
      </button>
    

    
      <button id="admin_button" type="button" class="btn btn-outline-danger  me-3 "> 
        <i class="bi bi-gear"></i>
        <span  > Admin felület</span>
      </button>
    

      <div class="row mt-auto p-2">
        <span id="user"></span>
        <span id="user-email"></span>
      </div>

      <button class="btn btn-success me-3" id="switch"><i class="bi bi-moon-fill" ></i></button>
      
      
      

      
      
    </div>
  </div>



  <div class="row">
    <div class="col-lg-12 fejléc p-3 text-center bg-black text-light"> <img class="img-fluid m-1" style="width: 50px; height: 55px;"  src="img/logoz.png"> <h3>SZ-1-B Iskolai Webáruház</h3></div>
  </div>

  <div class="row bg-black">
  
        <div class="col-lg-4">
         

            
              <button id="menu"  type="button" class="btn me-3 text-light" style="background-color: #125308;" data-bs-toggle="offcanvas" data-bs-target="#demo"> 
                
                <h1><i class="bi bi-list"></i></h1>
              </button>
              
            

            
            
          
          
        </div>
        
        <div class="col-lg-4">
          <div class="row">
            <div class="col-12">
              <div class="d-flex flex-nowrap w-100"> <!-- flex-nowrap: ne tordelje szet  -->
                <div class="form-floating flex-grow-1 me-2">
                  <input class="form-control" id="nev1" name="nev" type="text" placeholder="Termékek keresése...">
                  <label for="nev1">Termékek keresése...</label>
                </div>
                <button class="btn btn-success bi bi-search p-3" id="kereses_gomb"></button>
              </div>
              
          </div>
        </div>
          
        
          
        <div class="col-lg-4">&nbsp;</div>
        

          
            
          

          
         
        


    
  </div>

    
</div>



<!--

  
  <div class="badge text-wrap text-light" id="user" style="position:fixed; right:10px; top:10px;"></div>
  <div class="flex-doboz" style="background-color: #1d293d; color: #a1a4ae">  
      <form class="d-flex m-auto" id="form1">
        <select class="form-select"  id="kategoria1" name="kategoria"  style="width:400px;"></select> 
        <input  class="form-control" id="nev1"       name="nev"   type="text" placeholder="termék neve" style="width:300px;">
        <select class="form-select"  id="limit1"     name="limit" title="max. rekodszám" style="width:100px;">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
        </select> 
        <select class="form-select me-3" id="offset1" name="offset" title="offset" style="width:100px;"></select> 
      </form>
      <button id="search_button" type="button" class="btn btn-primary me-3 bi bi-search"> Keres</button>
      <button id="modify_button" type="button" class="btn btn-success me-3 bi bi-pencil-fill"> Módosít</button>
      <button id="delete_button" type="button" class="btn btn-danger  me-3 bi bi-trash"> Töröl</button>
      <button id="insert_button" type="button" class="btn btn-warning me-3 bi bi-plus-circle"> Új </button>
      <button id="login_button"  type="button" class="btn btn-secondary me-3 bi bi-person">Login</button>
  </div>
  
  -->

  <!--
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-4 col-lg-6"> 
          <div id="rekord1" class="mt-4 alert alert-info">
              
              <b>Telepítés:</b> (vs code mappa nyitás, ctrl_ö):  npm install util mysql2 express express-session<br />
              <b>Start:</b> npm start<br />
              <b>Elérés:</b> http://localhost:3000<br/>
          </div>
      </div>
      <div class="col-sm-8 col-lg-6"> 
        <table id="tabla1" class="table table-hover" style="cursor: pointer;">
          <thead>
            <tr>
              <th style="width:70%;" onclick="orderby(2);">NÉV</th>
              <th style="width:10%;" onclick="orderby(3);">ÁR</th>
              <th style="width:10%;" onclick="orderby(4);">Mennyiség</th>
              <th style="width:10%;" onclick="orderby(5);">meegys.</th>
            </tr>  
          </thead>
          <tbody>  </tbody>
        </table>
      </div>  
    </div>
  </div>-->



  <div class="container-fluid" id="content"> <!-- ide jon a tartalom -->
    
  </div>


  <div class="row p-3 bg-success text-light">
    <div class="col-lg-12 text-center">
      <a class="text-white" href="https://www.csany-zeg.hu/" target="_blank">Csány László Technikum</a> - (2025)
    </div>
  </div>





  

</div>






<!-- login ablak -->
<div class="modal fade" id="login_modal">
  <div class="modal-dialog modal-md" >
    <div class="modal-content" >
      <div class="modal-header bg-success text-light">
        <h4 id="idx_login" class="modal-title text-center w-100"><i class="bi bi-person-fill"></i> Bejelentkezés</h4>
      </div>

      <div id="idx0" class="modal-body">     
        <form id="form_login" class="row"> 

          <div class="form-floating my-1">
            <input type="text" class="form-control" id="login_nev" name="login_nev"  value="troppauer@emailcim.com">
            <label for="login_nev">E-mail cím</label>
          </div>

          <div class="form-floating my-1">
            <input type="password" class="form-control" id="login_passwd" name="login_passwd" value="123456">
            <label for="login_passwd">Jelszó</label>
            <span id="jelszo_mutatasa" class="position-absolute top-50 end-0 translate-middle-y pe-4" style="cursor:pointer;"> <!-- position absolute: pozicionalhato legyen jobbra
                                                                                                                               top-50 translate-middle-y: fuggolegesen kozepre  
                                                                                                                               end-0: jobb oldalra 
                                                                                                                               pe: padding end -->
              <i class="bi bi-eye" id="sz"></i>
            </span>
          </div>

        </form>
      </div>

      <div class="modal-footer  justify-content-center">
        
        
        <button id="bezar" type="button" class="btn btn-secondary" data-bs-dismiss="modal"> <i class="bi bi-incognito"></i> Böngészés vendégként</button>
        <button id="login_oksi_button" type="button" class="btn btn-success" data-bs-dismiss="modal"> <i class="bi bi-box-arrow-in-right"></i> Bejelentkezés</button>
        
        
        
      </div>

    </div>
  </div>
</div>

    <!----------------- modal adatbevitel ablak ----------------------->
    <div class="modal" id="myModal0">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-secondary text-white">
            <h4 id="idx1" class="modal-title">Modal Heading</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div id="idx0" class="modal-body bg-light">     
            <form id="mod1" class="row"> 
              <div class="form-floating my-1">
                <select class="form-select" id="mod_kat" name="mod_kat"></select>     
                <label for="mod_kat">Kategória</label>
              </div>

              <div class="form-floating my-1">
                <input type="text" class="form-control" id="mod_nev" name="mod_nev">
                <label for="mod_nev">Termék neve</label>
              </div>

              <div class="form-floating my-1">
                <input type="text" class="form-control" id="mod_azon" name="mod_azon">
                <label for="mod_azon">Azonosító</label>
              </div>
        
              <div class="form-floating my-1 mr-1" style="width:190px;">
                  <input type="number" class="form-control" id="mod_ar" name="mod_ar">
                  <label for="mod_ar">Ár</label>
              </div>
              <div class="form-floating my-1 mr-1" style="width:190px;">
                  <input type="number" class="form-control" id="mod_db" name="mod_db">
                  <label for="mod_db">Mennyiség</label>
              </div>
              <div class="form-floating my-1 mr-1" style="width:190px;">
                  <input type="text" class="form-control" id="mod_meegys" name="mod_meegys">
                  <label for="mod_meegys">Egység</label>
              </div>

              <div class="form-floating my-1 mr-1" style="width:200px;">
                <input type="date" class="form-control" id="mod_datum" name="mod_datum">
                <label for="mod_datum">Dátum</label>
              </div>

              <div class="form-floating my-1">
                <textarea class="form-control "rows="4" id="mod_leiras" name="mod_leiras"></textarea>
                <label for="mod_leiras">Leírás</label>
              </div>

            </form>
          </div>

          <div class="modal-footer bg-light">
            <button id="save_button" type="button" class="btn btn-success" data-bs-dismiss="modal"> <i class="bi bi-save2"></i> Ment</button>
          </div>

        </div>
      </div>
    </div>

    <!-- toast mysend -->
    <div id= "toast1" class="toast bg-success text-white hide" style="position:fixed; right:10px; bottom:10px;">
      <div class="toast-header">
          <strong class="me-auto"><i class="bi-gift-fill"></i> Infó...</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body"></div>
    </div>

    <!-- modal popup ablak -->
    <div class="modal" id="myModal1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h4 class="modal-title">Megerősítés</h4></div>
          <div class="modal-body"></div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

</body>
</html>